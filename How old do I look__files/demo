function processRequest(n,t,i,r,u){showGameIfAllowed(n,t,i);window.location.hash="results";deleteFaceRects();$("#imageSpacer").css("height","0px");$("#attributionMainId").hide();$("#jsonEventDiv").hide();var h='<span><img id="loadingImage" src="/Images/ajax-loader_1.gif" /><\/span>'+$("#analyzingText").val(),e=$("#couldntDetectText").val()+" "+$("#VerifyImageText").val(),c=$("#couldntDetectText").val();$("#analyzingLabel").css("visibility","visible");$("#improvingLabel").css("visibility","hidden");$("#analyzingLabel").html(h);var o={},s=!1,f="/Home/Analyze",y=$("#uploadBtn").get(0).files,l=$("#isTest").val(),a=$("#source").val(),v=document.location.hostname;if(f+="?isTest="+l+"&source="+a+"&version="+v,n){if(r!=null&&r>10145728){$("#jsonEventDiv").hide();$("#analyzingLabel").html(e);$("#analyzingLabel").css("visibility","visible");return}o=u;s="application/octet-stream"}else f+="&faceUrl="+encodeURIComponent(t)+"&faceName="+i;lastRequest=null;$.ajax({type:"POST",url:f,contentType:s,processData:!1,data:o,success:function(n){var t=JSON.parse(n),i;t==null||t.Faces==null||t.Faces.length===0?($("#analyzingLabel").html(c),$("#analyzingLabel").css("visibility","visible")):(renderImageFaces(t.Faces,0),$("#analyzingLabel").css("visibility","hidden"),i=JSON.parse(t.AnalyticsEvent),setGameRequestId(i[0].session_id));$("#improvingLabel").css("visibility","visible");t!=null&&(showViewSourceLink(),$("#jsonEvent").text(t.AnalyticsEvent));adjustAttirbutionLinkLocation()},error:function(){$("#jsonEventDiv").hide();$("#analyzingLabel").html(e);$("#analyzingLabel").css("visibility","visible");adjustAttirbutionLinkLocation()}})}function viewSource(){$("#jsonEventDiv").show()}function showResultView(){$("#selectImage").hide();$("#results").show()}function showSelectionView(){$("#selectImage").show();$("#results").hide();hideViewSourceLink();myScroll.refresh()}function showViewSourceLink(){$("#viewEvent").show();$("#linkSeparetor").show()}function hideViewSourceLink(){$("#viewEvent").hide();$("#linkSeparetor").hide()}function analyzeUrl(){var n=document.getElementById("SelectorBox").getBoundingClientRect(),t=document.elementFromPoint(n.left+n.width/2,n.top+n.height/2),r=$(t).attr("data-url"),u=$(t).attr("data-orig-domain"),f=$(t).attr("data-orig-url"),i=$(t).attr("data-image-name");i==undefined&&(i=null);updateThumbnail(r,u,f);processRequest(!1,r,i)}function handleFileSelect(n){for(var u=n.target.files,t,r,i=0;t=u[i];i++)(!t.type||t.type.match("image.*"))&&(r=t,loadImage.parseMetaData(r,function(n){var t={canvas:!0,maxWidth:2e3,maxHeight:2e3};n&&n.exif&&(t.orientation=n.exif.get("Orientation"));loadImage(r,function(n){var t=n.toDataURL("image/jpeg",.75),i=dataURItoBlob(t);updateThumbnail(t,null,null);processRequest(!0,null,null,i.size,i)},t)}))}function dataURItoBlob(n){var i,u,r,t;for(i=n.split(",")[0].indexOf("base64")>=0?atob(n.split(",")[1]):unescape(n.split(",")[1]),u=n.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(i.length),t=0;t<i.length;t++)r[t]=i.charCodeAt(t);return new Blob([r],{type:u})}function updateThumbnail(n,t,i){var r=document.getElementById("thumbnail");$("#attributionMainId").html(t);$("#attributionMainId").attr("href",i);r.setAttribute("src",n)}function showGameIfAllowed(n,t,i){enableGame&&!i?($("#gameBtn").prop("disabled",!0),$("#gameLauncher").show()):$("#gameLauncher").hide()}function setGameRequestId(n){lastRequestId=n;$("#gameBtn").prop("disabled",!1)}function dismissNotification(){createCookie(currentNotification,"dismiss",10);$(".site-notification").slideUp(400)}function getCookie(n){for(var r=n+"=",u=document.cookie.split(";"),t,i=0;i<u.length;i++){for(t=u[i];t.charAt(0)==" ";)t=t.substring(1,t.length);if(t.indexOf(r)==0)return t.substring(r.length,t.length)}return null}function createCookie(n,t,i){var r,u;i?(r=new Date,r.setTime(r.getTime()+i*864e5),u="; expires="+r.toGMTString()):u="";document.cookie=n+"="+t+u+"; path=/"}function drawFaceRects(){var n,t;if($("#faces").html("<div><\/div>"),n=$("#thumbnail"),current_faces!=null){var u=$("#thumbContainer"),f=n.offset().left-u.offset().left,i=n.height()/image_orig_height,r=n.width()/image_orig_width,e=current_faces.length;$.each(current_faces,function(t,u){var s=u.faceRectangle,h=u.attributes.age,c=u.attributes.gender,o={};o.top=Math.round(i*s.top);o.height=Math.round(i*s.height);o.left=Math.round(r*s.left)+f;o.width=Math.round(r*s.width);var l=adjustRectOrientation(o,n.width(),n.height(),image_orig_rotation),a=$("#faces"),v=add_rect(l,h,c,t,a,e)});t=0;$(".tooltip").each(function(n,i){t=Math.min(t,i.offsetTop)});$("#imageSpacer").css("height",Math.abs(t)+"px")}}function adjustAttirbutionLinkLocation(){var n=$("#thumbnail"),t=$("#thumbContainer"),i=n.offset().left-t.offset().left;$("#attributionMainId").show();$("#attributionMainId").css("left",i+2+"px")}function adjustRectOrientation(n,t,i,r){var u={};return iOS||r===0?n:r===270?(u.height=n.width,u.width=n.height,u.left=n.top,u.top=i-u.height-n.left,u):r===180?(u.height=n.height,u.width=n.width,u.left=t-u.width-n.left,u.top=i-u.height-n.top,u):r===90?(u.height=n.width,u.width=n.height,u.left=t-u.width-n.top,u.top=n.left,u):n}function renderImageFaces(n,t){current_faces=n;updateOrigImageDimensions(drawFaceRects,t)}function updateOrigImageDimensions(n,t){var r=document.getElementById("thumbnail"),i=new Image;i.onload=function(){image_orig_width=iOS&&(t===270||t===90)?i.height:i.width;image_orig_height=iOS&&(t===270||t===90)?i.width:i.height;image_orig_rotation=t;n()};i.src=r.src}function deleteFaceRects(){current_faces=[];$("#faces").html("<div><\/div>")}function resize(){drawFaceRects();adjustAttirbutionLinkLocation()}function updateSelectedImage(){selectedImage=$(".ImageSelector .ScrollArea *")[myScroll.currentPage.pageX];selectedImage&&(selectedImage.className="selectedImage",$("#attributionId").html($(selectedImage).attr("data-orig-domain")),$("#attributionId").attr("data-orig-url",$(selectedImage).attr("data-orig-url")))}function refresh(){myScroll.options.snap=myScroll.scroller.querySelectorAll("*");$(".ImageSelector .ScrollArea *").on("tap",function(){myScroll.currentPage.pageX!=$(this).index()&&($(".ImageSelector .ScrollArea .selectedImage").removeClass("selectedImage"),myScroll.goToPage($(this).index(),0,400))});var n=$(".ImageSelector .ScrollArea *"),t=parseInt(n.css("margin-left").replace("px",""))||0,i=parseInt(n.css("margin-right").replace("px",""))||0,r=n[0].offsetWidth,u=(r+t+i)*n.length;$(".ImageSelector .ScrollArea").css("width",u+"px");myScroll.refresh();myScroll.goToPage((n.length/2).toFixed(0)-1,0,0,!1);updateSelectedImage()}function loaded(){var n=$(".ImageSelector .ScrollArea *"),t=parseInt(n.css("margin-left").replace("px",""))||0,i=parseInt(n.css("margin-right").replace("px",""))||0,r=n[0].offsetWidth,u=(r+t+i)*n.length;$(".ImageSelector .ScrollArea").css("width",u+"px");myScroll=new IScroll(".ImageSelector",{scrollX:!0,scrollY:!1,mouseWheel:!0,snap:"*",momentum:!0,tap:!0,scrollbars:!0,deceleration:.002,bounce:!1});myScroll.goToPage((n.length/2).toFixed(0)-1,0,0,!1);$(".ImageSelector .ScrollArea *").on("tap",function(){myScroll.currentPage.pageX!=$(this).index()&&($(".ImageSelector .ScrollArea .selectedImage").removeClass("selectedImage"),myScroll.goToPage($(this).index(),0,400))});myScroll.on("flick",function(){this.x==this.startX&&updateSelectedImage()});myScroll.on("scrollEnd",updateSelectedImage);myScroll.on("scrollStart",function(){$(".ImageSelector .ScrollArea .selectedImage").removeClass("selectedImage")});$("#attributionId").on("tap",function(){var n=$("#attributionId").attr("data-orig-url");n!==undefined&&window.open(n,"_blank")});$(".ImageSelector").css("opacity",1);updateSelectedImage()}var iOS=!1,enableGame,gameName,gameUrlBase,lastRequestId,currentNotification,current_faces,image_orig_width,image_orig_height,image_orig_rotation,add_rect,selectedImage,myScroll;$(window).load(function(){document.getElementById("uploadBtn").addEventListener("change",handleFileSelect,!1);document.getElementById("uploadBtn").addEventListener("click",function(){this.value=null},!1);window.location.hash="";iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1});$(window).on("hashchange",function(){window.location.hash==="#results"?showResultView():showSelectionView()});$("#viewEvent").click(function(){return viewSource(),!1});gameUrlBase="//game.how-old.net/";$("#gameBtn").click(function(){var n=gameName?"/"+gameName:"",t=gameUrlBase+"Game"+n+"?requestId="+lastRequestId;window.location.href=t});currentNotification="notification-what-dog";getCookie(currentNotification)||(document.URL.indexOf("q=")>0?$(".site-notification").show():$(".site-notification").delay(3e3).slideDown(400));current_faces=[];add_rect=function(n,t,i,r,u,f){var o="rect"+Math.round(Math.random()*1e4),e=null,c="n/a",s,h,l,a;t!=null&&(c=Math.round(Number(t)));s="/Images/icon-gender-male.png";i!=null&&i.toLowerCase()==="female"&&(s="/Images/icon-gender-female.png");h=f<=2?"big-face-tooltip":"small-face-tooltip";e='<div><span><img src="'+s+'" class='+h+"><\/span>"+c+"<\/div>";$(e).css("background-color","#F1D100");l='<div data-html="true" class="child face-tooltip '+h+' " id="'+o+'"/>';$(l).appendTo(u).css("left",n.left+"px").css("top",n.top+"px").css("width",n.width+"px").css("height",n.height+"px").css("border","1px solid white").css("position","absolute");e!=null&&(a="top",$("#"+o).tooltip({trigger:"manual",show:!0,placement:a,title:e,html:!0}),$("#"+o).tooltip("show"))};window.onresize=resize;document.getElementById("SelectorTag").addEventListener("mousedown",function(n){n.cancelBubble=!0},!1);loaded()